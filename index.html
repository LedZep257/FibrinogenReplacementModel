<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Fibrinogen Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .input-page {
            max-width: 500px;
            margin: 0 auto;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        .label-note {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: normal;
            margin-left: 5px;
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }
        .error {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
            width: 100%;
            margin-top: 20px;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .back-btn {
            background-color: #95a5a6;
            color: white;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            background-color: #7f8c8d;
        }
        .graph-page-content {
            display: flex;
            gap: 20px;
        }
        .graph-section {
            flex: 1;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .product-btn {
            padding: 10px 20px;
            border: 2px solid #34495e;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .product-btn:hover {
            background-color: #34495e;
            color: white;
        }
        .ffp-btn:hover {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        .cryo-btn:hover {
            background-color: #f39c12;
            border-color: #f39c12;
        }
        .fib-btn:hover {
            background-color: #27ae60;
            border-color: #27ae60;
        }
        .rbc-btn:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        .blood-loss-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .blood-loss-input input {
            width: 150px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .blood-loss-input button {
            padding: 8px 16px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .blood-loss-input button:hover {
            background-color: #8e44ad;
        }
        .tally-chart {
            min-width: 250px;
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }
        .tally-chart h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .tally-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .tally-item.ffp {
            border-left-color: #e74c3c;
        }
        .tally-item.cryo {
            border-left-color: #f39c12;
        }
        .tally-item.fib {
            border-left-color: #27ae60;
        }
        .tally-item.rbc {
            border-left-color: #c0392b;
        }
        .tally-label {
            font-weight: bold;
        }
        .tally-count {
            font-size: 1.2em;
            color: #2c3e50;
        }
        #chart {
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            height: 500px;
        }
        .stats-box {
            margin-top: 20px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
        }
        .stats-box > div {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 30px;
            height: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Blood Fibrinogen Tracker</h1>
        
        <!-- Input Page -->
        <div id="inputPage" class="page active">
            <div class="input-page">
                <div class="input-group">
                    <label>Initial Clauss Fibrinogen (g/L)</label>
                    <input type="number" id="initialFibrinogen" step="0.1" placeholder="0.3 - 10">
                    <span id="fibrinogenError" class="error" style="display: none;"></span>
                </div>

                <div class="input-group">
                    <label>Measured Blood Loss (ml)</label>
                    <input type="number" id="bloodLoss" step="1" placeholder="0 - 20000">
                    <span id="bloodLossError" class="error" style="display: none;"></span>
                </div>

                <div class="input-group">
                    <label>
                        Body Weight (kg)
                        <span class="label-note">- Total blood volume is estimated based on body weight</span>
                    </label>
                    <input type="number" id="bodyWeight" step="1" placeholder="30 - 200">
                    <span id="bodyWeightError" class="error" style="display: none;"></span>
                </div>

                <button class="btn btn-primary" onclick="confirmInputs()">Confirm</button>
            </div>
        </div>

        <!-- Graph Page -->
        <div id="graphPage" class="page">
            <button class="btn back-btn" onclick="goBack()">‚Üê Back to Input</button>
            
            <div class="controls">
                <button class="product-btn ffp-btn" onclick="addProduct('ffp')">FFP</button>
                <button class="product-btn cryo-btn" onclick="addProduct('cryo')">Cryoprecipitate</button>
                <button class="product-btn fib-btn" onclick="addProduct('fib')">Fibrinogen Concentrate</button>
                <button class="product-btn rbc-btn" onclick="addProduct('rbc')">Red Blood Cells</button>
                
                <div class="blood-loss-input">
                    <label style="font-size: 0.9em; font-weight: bold;">Additional Measured Blood Loss (ml)</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="additionalBloodLoss" placeholder="Enter ml">
                        <button onclick="addBloodLoss()">Add</button>
                    </div>
                </div>
            </div>

            <div class="graph-page-content">
                <div class="graph-section">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e74c3c;"></div>
                            <span>Fibrinogen (g/L)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9b59b6;"></div>
                            <span>Blood Loss (ml)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3498db;"></div>
                            <span>Blood Volume (ml)</span>
                        </div>
                    </div>
                    <canvas id="chart"></canvas>
                </div>

                <div class="tally-chart">
                    <h3>Products Given</h3>
                    <div class="tally-item ffp">
                        <span class="tally-label">FFP</span>
                        <span class="tally-count" id="ffpCount">0</span>
                    </div>
                    <div class="tally-item cryo">
                        <span class="tally-label">Cryoprecipitate</span>
                        <span class="tally-count" id="cryoCount">0</span>
                    </div>
                    <div class="tally-item fib">
                        <span class="tally-label">Fibrinogen Concentrate</span>
                        <span class="tally-count" id="fibCount">0</span>
                    </div>
                    <div class="tally-item rbc">
                        <span class="tally-label">Red Blood Cells</span>
                        <span class="tally-count" id="rbcCount">0</span>
                    </div>
                    <div class="stats-box">
                        <div><strong>Current Fibrinogen:</strong> <span id="currentFib">0</span> g/L</div>
                        <div><strong>Blood Volume:</strong> <span id="currentVolume">0</span> ml</div>
                        <div><strong>Cumulative Blood Loss:</strong> <span id="currentLoss">0</span> ml</div>
                    </div>
                    <button class="btn btn-primary" onclick="startAgain()" style="margin-top: 20px; width: 100%;">Start Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            totalBloodVolume: 0,
            plasmaVolume: 0,
            totalFibrinogenMass: 0,
            currentFibrinogen: 0,
            cumulativeBloodLoss: 0,
            ffpCount: 0,
            cryoCount: 0,
            fibCount: 0,
            rbcCount: 0,
            currentTime: 0,
            timePoints: []
        };

        function validate() {
            let isValid = true;
            
            const fibrinogen = parseFloat(document.getElementById('initialFibrinogen').value);
            const fibError = document.getElementById('fibrinogenError');
            if (isNaN(fibrinogen) || fibrinogen < 0.3 || fibrinogen > 10) {
                fibError.textContent = 'Fibrinogen must be between 0.3 and 10 g/L';
                fibError.style.display = 'block';
                isValid = false;
            } else {
                fibError.style.display = 'none';
            }

            const bloodLoss = parseFloat(document.getElementById('bloodLoss').value);
            const lossError = document.getElementById('bloodLossError');
            if (isNaN(bloodLoss) || bloodLoss < 0 || bloodLoss > 20000) {
                lossError.textContent = 'Blood loss must be between 0 and 20000 ml';
                lossError.style.display = 'block';
                isValid = false;
            } else {
                lossError.style.display = 'none';
            }

            const bodyWeight = parseFloat(document.getElementById('bodyWeight').value);
            const weightError = document.getElementById('bodyWeightError');
            if (isNaN(bodyWeight) || bodyWeight < 30 || bodyWeight > 200) {
                weightError.textContent = 'Body weight must be between 30 and 200 kg';
                weightError.style.display = 'block';
                isValid = false;
            } else {
                weightError.style.display = 'none';
            }

            return isValid;
        }

        function confirmInputs() {
            if (!validate()) return;

            const fib = parseFloat(document.getElementById('initialFibrinogen').value);
            const loss = parseFloat(document.getElementById('bloodLoss').value);
            const weight = parseFloat(document.getElementById('bodyWeight').value);

            // Calculate blood volume (100ml/kg for term pregnancy)
            const initialTbv = weight * 100;
            
            // Subtract initial blood loss from starting volume
            const tbv = initialTbv - loss;
            const pv = tbv * 0.5; // 50% is plasma

            state.totalBloodVolume = tbv;
            state.plasmaVolume = pv;
            state.cumulativeBloodLoss = loss;

            // Initial fibrinogen mass (g) - concentration remains the same after loss
            state.totalFibrinogenMass = fib * (pv / 1000);
            state.currentFibrinogen = fib;
            
            // Reset counts
            state.ffpCount = 0;
            state.cryoCount = 0;
            state.fibCount = 0;
            state.rbcCount = 0;
            state.currentTime = 0;

            state.timePoints = [{
                time: 0,
                fibrinogen: fib,
                bloodLoss: loss,
                bloodVolume: tbv
            }];

            // Switch to graph page
            document.getElementById('inputPage').classList.remove('active');
            document.getElementById('graphPage').classList.add('active');

            updateDisplay();
            drawChart();
        }

        function goBack() {
            document.getElementById('graphPage').classList.remove('active');
            document.getElementById('inputPage').classList.add('active');
        }

        function addProduct(type) {
            let volumeAdded = 0;
            let plasmaAdded = 0;
            let fibrinogenAdded = 0;

            if (type === 'ffp') {
                volumeAdded = 250;
                plasmaAdded = 250;
                fibrinogenAdded = 0.625;
                state.ffpCount++;
            } else if (type === 'cryo') {
                volumeAdded = 100;
                plasmaAdded = 100;
                fibrinogenAdded = 1.25;
                state.cryoCount++;
            } else if (type === 'fib') {
                volumeAdded = 50;
                plasmaAdded = 50;
                fibrinogenAdded = 1.0;
                state.fibCount++;
            } else if (type === 'rbc') {
                volumeAdded = 300;
                plasmaAdded = 100; // 100ml plasma, 200ml cells
                fibrinogenAdded = 0;
                state.rbcCount++;
            }

            // Update blood volume
            state.totalBloodVolume += volumeAdded;
            state.plasmaVolume += plasmaAdded;

            // Update fibrinogen
            state.totalFibrinogenMass += fibrinogenAdded;
            state.currentFibrinogen = state.totalFibrinogenMass / (state.plasmaVolume / 1000);

            // Add time point
            state.currentTime++;
            state.timePoints.push({
                time: state.currentTime,
                fibrinogen: state.currentFibrinogen,
                bloodLoss: state.cumulativeBloodLoss,
                bloodVolume: state.totalBloodVolume
            });

            updateDisplay();
            drawChart();
        }

        function addBloodLoss() {
            const loss = parseFloat(document.getElementById('additionalBloodLoss').value);
            if (isNaN(loss) || loss < 0) return;

            state.cumulativeBloodLoss += loss;
            
            // Decrease blood volume by the blood loss amount
            state.totalBloodVolume -= loss;
            const plasmaLoss = loss * 0.5; // 50% of blood loss is plasma
            state.plasmaVolume -= plasmaLoss;
            
            // Lose fibrinogen proportionally (at current concentration)
            // If we lose plasma at the current concentration, the concentration stays the same
            const fibrinogenLost = state.currentFibrinogen * (plasmaLoss / 1000);
            state.totalFibrinogenMass -= fibrinogenLost;
            
            // Concentration remains the same: totalMass / plasmaVolume
            state.currentFibrinogen = state.totalFibrinogenMass / (state.plasmaVolume / 1000);
            
            // Add time point
            state.currentTime++;
            state.timePoints.push({
                time: state.currentTime,
                fibrinogen: state.currentFibrinogen,
                bloodLoss: state.cumulativeBloodLoss,
                bloodVolume: state.totalBloodVolume
            });

            document.getElementById('additionalBloodLoss').value = '';
            updateDisplay();
            drawChart();
        }

        function updateDisplay() {
            document.getElementById('ffpCount').textContent = state.ffpCount;
            document.getElementById('cryoCount').textContent = state.cryoCount;
            document.getElementById('fibCount').textContent = state.fibCount;
            document.getElementById('rbcCount').textContent = state.rbcCount;
            document.getElementById('currentFib').textContent = state.currentFibrinogen.toFixed(2);
            document.getElementById('currentVolume').textContent = state.totalBloodVolume.toFixed(0);
            document.getElementById('currentLoss').textContent = state.cumulativeBloodLoss.toFixed(0);
        }

        function startAgain() {
            // Reset all state
            state = {
                totalBloodVolume: 0,
                plasmaVolume: 0,
                totalFibrinogenMass: 0,
                currentFibrinogen: 0,
                cumulativeBloodLoss: 0,
                ffpCount: 0,
                cryoCount: 0,
                fibCount: 0,
                rbcCount: 0,
                currentTime: 0,
                timePoints: []
            };
            
            // Clear input fields
            document.getElementById('initialFibrinogen').value = '';
            document.getElementById('bloodLoss').value = '';
            document.getElementById('bodyWeight').value = '';
            document.getElementById('additionalBloodLoss').value = '';
            
            // Hide error messages
            document.getElementById('fibrinogenError').style.display = 'none';
            document.getElementById('bloodLossError').style.display = 'none';
            document.getElementById('bodyWeightError').style.display = 'none';
            
            // Go back to input page
            document.getElementById('graphPage').classList.remove('active');
            document.getElementById('inputPage').classList.add('active');
        }

        function drawChart() {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 60;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Draw background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // Scales
            const maxTime = 30; // Fixed scale to 30 interventions
            const fibMax = 12;
            const volumeMax = 20000;

            // Draw axes
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Right Y-axis
            ctx.beginPath();
            ctx.moveTo(width - padding, padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw grid and labels
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';

            // Y-axis (fibrinogen) - left
            for (let i = 0; i <= 12; i += 2) {
                const y = height - padding - (i / fibMax) * graphHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                ctx.textAlign = 'right';
                ctx.fillText(i.toString(), padding - 10, y + 4);
            }

            // Y-axis label (left)
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Clauss Fibrinogen (g/L)', 0, 0);
            ctx.restore();

            // Y-axis (volume) - right
            for (let i = 0; i <= 20000; i += 4000) {
                const y = height - padding - (i / volumeMax) * graphHeight;
                ctx.textAlign = 'left';
                ctx.fillText(i.toString(), width - padding + 10, y + 4);
            }

            // Y-axis label (right)
            ctx.save();
            ctx.translate(width - 15, height / 2);
            ctx.rotate(Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Volume (ml)', 0, 0);
            ctx.restore();

            // X-axis
            for (let i = 0; i <= 30; i += 5) {
                const x = padding + (i / maxTime) * graphWidth;
                ctx.textAlign = 'center';
                ctx.fillText(i.toString(), x, height - padding + 20);
            }

            // X-axis label
            ctx.textAlign = 'center';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Intervention', width / 2, height - 10);

            // Draw data lines
            if (state.timePoints.length > 1) {
                // Fibrinogen line (red)
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 3;
                ctx.beginPath();
                state.timePoints.forEach((point, index) => {
                    const x = padding + (point.time / maxTime) * graphWidth;
                    const y = height - padding - (point.fibrinogen / fibMax) * graphHeight;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Blood loss line (purple)
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                state.timePoints.forEach((point, index) => {
                    const x = padding + (point.time / maxTime) * graphWidth;
                    const y = height - padding - (point.bloodLoss / volumeMax) * graphHeight;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Blood volume line (blue)
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                state.timePoints.forEach((point, index) => {
                    const x = padding + (point.time / maxTime) * graphWidth;
                    const y = height - padding - (point.bloodVolume / volumeMax) * graphHeight;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Draw points
                state.timePoints.forEach(point => {
                    const x = padding + (point.time / maxTime) * graphWidth;
                    
                    // Fibrinogen point
                    const yFib = height - padding - (point.fibrinogen / fibMax) * graphHeight;
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(x, yFib, 4, 0, 2 * Math.PI);
                    ctx.fill();

                    // Blood loss point
                    const yLoss = height - padding - (point.bloodLoss / volumeMax) * graphHeight;
                    ctx.fillStyle = '#9b59b6';
                    ctx.beginPath();
                    ctx.arc(x, yLoss, 4, 0, 2 * Math.PI);
                    ctx.fill();

                    // Blood volume point
                    const yVol = height - padding - (point.bloodVolume / volumeMax) * graphHeight;
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, yVol, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
        }

        // Redraw chart on window resize
        window.addEventListener('resize', () => {
            if (document.getElementById('graphPage').classList.contains('active')) {
                drawChart();
            }
        });
    </script>
</body>
</html>
